<html>
<head>
<style>
    #draggable { width: 150px; height: 150px; padding: 0.5em; }  
    .column { border-right: 1px solid black; height: 100%; float: left; text-align: center, width: 100% }
    .menu { width: 100% }
    .wrapper { width: 1024px }
</style>
  
</head>
<body>
<div class="wrapper">
<div class='menu'>
    <a href='' id='columnAdd' >Add a column</a>
    <a href='' id='storyAdd' >Add a story</a>
</div>
<div class='column'>
	<h1>Can I haz storiez?</h1>
</div>

</div>
<script src='http://127.0.0.1/kanbanjs/frontend/jquery.min.js' ></script>
<script src='http://127.0.0.1/kanbanjs/frontend/jquery-ui.js' ></script>
<script src="/socket.io/socket.io.js"></script>

<script>
  var socket = io.connect(); 
  socket.on('initStories', function (data) {
    var stories = data.data;

    for (key in stories) {
      if (stories[key].top)
      {
        addStory(stories[key].top, stories[key].left);
      } else {
        addStory();
      }
    }
  });

  socket.on('initColumns', function (data) {
    var columns = data.data;
    
    for (i = 0; i < columns; i++) {
        addColumn()
    }
  });

  socket.on('addcolumn', function () {
    addColumn();
  });


  socket.on('addstory', function () {
    addStory();
  });


  socket.on('movestory', function (data) {
    $( "#" + data.data.data.id ).animate({ 'top': data.data.data.top, 'left': data.data.data.left }, 0);
  });


function addColumn ()
{
  var columns = $( ".column" ).length + 1;
  $( ".column" ).last().after('<div class="column"><h1>Plz more</h1></div>');
  $( ".column" ).css('width', 90/columns + '%');
}
 
function addStory (top, left)
{
    var story = $('<div class="movable editable story" id="story-' + $('.story').length + '" >Story</div>');
    $( ".column" ).first().append(story);
    if (top !== undefined) {
      story.animate({ 'top': top, 'left': left }, 0);
    }
    $( ".movable" ).draggable({
       drag: function(event, ui) {
        info = {};
        info.id = $(this).attr('id');
        info.top = ui.position.top;
        info.left = ui.position.left;
        socket.emit('movestory', { "data": info });
      }
    });
    $( ".editable" ).dblclick(function(){
      id = $(this).attr('id');
      story = $("#" + id);
      $("input").remove();
      story.hide();
      story.after("<input type='text' value='" + $("#" + id).html() + "' />");
      $('input').css('position', 'absolute');
      $('input').css('left', story.css('left'));
      var top = parseInt(story.css('top'));
      $('input').css('top', (top + 100) + 'px');
        $("input").focusout(function(){
            val = $(this).attr('value');
            story.html(val);
            info = {};
            info.storyId = id;
            info.storyValue = val;
            $("input").remove();
            story.show();
        });
    });
};
 
$( "#columnAdd" ).click(function(){
  addColumn();
  socket.emit('addcolumn');

  return false;
});
$( "#storyAdd" ).click(function(){
  addStory();
  socket.emit('addstory');
  
  return false;
});
</script>


</body>
</html>
